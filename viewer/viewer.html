<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Visualizador AR - WebRA PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Librerías necesarias -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-chromakey-material@^1.0.0/dist/aframe-chromakey-material.min.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
    <style>
        body {margin: 0; overflow: hidden;}
        #playButton {
            position: absolute; z-index: 10; left: 50%; top: 50%; transform: translate(-50%, -50%);
            padding: 20px 35px; font-size: 1.5rem; border: none; border-radius: 12px; background: #2e88f8;
            color: #fff; cursor: pointer; box-shadow: 0 4px 30px rgba(0,0,0,0.1);
        }
        #playButton:active { background: #10417a; }
        .overlay {
            position: absolute; top:0; left:0; right:0; bottom:0;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20;
            background:rgba(0,0,0,0.75); color:white; font-size:1.2rem;
        }
        .hidden {display:none;}
        model-viewer { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="loader" class="overlay">
        <div style="margin-bottom:18px">Cargando proyecto...</div>
        <div class="spinner" style="border:5px solid #444;border-top:5px solid #fff;width:40px;height:40px;border-radius:50%;animation:spin 1s linear infinite"></div>
    </div>
    <button id="playButton" style="display:none;">▶ Play Video</button>
    <div id="ar-container"></div>

    <script>
        // Utilidad para convertir #00FF00 a "0,1,0"
        function hexToRGBString(hex) {
            hex = hex.replace(/^#/, '');
            if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
            const num = parseInt(hex, 16);
            return [
                ((num >> 16) & 255) / 255,
                ((num >> 8) & 255) / 255,
                (num & 255) / 255
            ].map(x => x.toFixed(2)).join(',');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'https://apiwebra.scanmee.io';
            const loader = document.getElementById('loader');
            const arContainer = document.getElementById('ar-container');
            const playButton = document.getElementById('playButton');

            const showError = msg => {
                loader.innerHTML = `<div style="color:red;">${msg}</div>`;
                loader.classList.remove('hidden');
            };

            // --- MAIN FLOW ---
            (async function(){
                try {
                    // Extraer el projectId dinámicamente de la URL
                    const pathParts = window.location.pathname.split('/');
                    const projectId = pathParts.pop() || pathParts.pop();
                    if (!projectId) throw new Error("ID de proyecto no encontrado.");

                    // Fetch de la API de tu backend
                    const response = await fetch(`${API_BASE_URL}/api/public/projects/${projectId}`);
                    if (!response.ok) throw new Error(`Proyecto no encontrado (Error ${response.status})`);
                    const projectData = await response.json();

                    // --- CARGA DINÁMICA DE VIDEO CON CHROMA ---
                    if (projectData.asset_type === 'video') {
                        loader.classList.add('hidden');
                        playButton.style.display = "block";

                        playButton.onclick = function() {
                            playButton.style.display = "none";
                            loader.classList.remove('hidden');
                            // Limpiar antes de inyectar
                            arContainer.innerHTML = "";

                            // Crear la escena
                            const scene = document.createElement('a-scene');
                            scene.setAttribute('embedded', '');
                            scene.setAttribute('vr-mode-ui', 'enabled: false');
                            scene.setAttribute('arjs', 'sourceType: webcam; detectionMode: mono_and_matrix; debugUIEnabled: false;');
                            scene.setAttribute('renderer', 'logarithmicDepthBuffer: true;');

                            // Assets: el video
                            const assets = document.createElement('a-assets');
                            const videoAsset = document.createElement('video');
                            videoAsset.setAttribute('id', 'videoChroma');
                            videoAsset.setAttribute('src', projectData.model_url);
                            videoAsset.setAttribute('loop', 'true');
                            videoAsset.setAttribute('crossorigin', 'anonymous');
                            videoAsset.setAttribute('webkit-playsinline', '');
                            videoAsset.setAttribute('playsinline', '');
                            videoAsset.setAttribute('preload', 'auto');
                            assets.appendChild(videoAsset);
                            scene.appendChild(assets);

                            // El marker
                            const marker = document.createElement('a-marker');
                            if(projectData.marker_type === 'image' && projectData.marker_url) {
                                marker.setAttribute('type', 'pattern');
                                marker.setAttribute('url', projectData.marker_url);
                            } else {
                                marker.setAttribute('preset', 'hiro'); 
                            }
                            marker.setAttribute('emitevents', 'true');

                            // El color chroma desde base de datos
                            const chromaColor = projectData.chroma_key_color || '#00FF00';
                            const chromaRGB = hexToRGBString(chromaColor);

                            // Plano con shader de chroma
                            const plane = document.createElement('a-plane');
                            plane.setAttribute('width', '1.6');
                            plane.setAttribute('height', '0.9');
                            plane.setAttribute('rotation', '-90 0 0');
                            plane.setAttribute('chromakey-material', `src: #videoChroma; color: ${chromaRGB};`);

                            marker.appendChild(plane);
                            scene.appendChild(marker);
                            scene.appendChild(document.createElement('a-camera'));
                            arContainer.appendChild(scene);

                            // Esperar a que el video esté listo
                            const videoElem = assets.querySelector('#videoChroma');
                            videoElem.addEventListener('loadeddata', function() {
                                loader.classList.add('hidden');
                                videoElem.play();
                            });
                        };
                    }
                    // --- CARGA DE MODELO 3D ---
                    else {
                        loader.classList.add('hidden');
                        arContainer.innerHTML = "";
                        const modelViewer = document.createElement('model-viewer');
                        modelViewer.setAttribute('src', projectData.model_url);
                        modelViewer.setAttribute('ar', '');
                        modelViewer.setAttribute('ar-modes', 'webxr scene-viewer quick-look');
                        modelViewer.setAttribute('camera-controls', '');
                        modelViewer.setAttribute('enable-pan', '');
                        modelViewer.setAttribute('autoplay', '');
                        modelViewer.setAttribute('crossorigin', 'anonymous');
                        modelViewer.style.width = "100vw";
                        modelViewer.style.height = "100vh";
                        arContainer.appendChild(modelViewer);
                    }
                } catch(err) {
                    showError("ERROR: " + err.message);
                }
            })();
        });
    </script>
</body>
</html>
