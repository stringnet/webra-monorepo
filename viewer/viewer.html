<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de RA - WebRA</title>
    <!-- Importamos A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .ar-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        .instruction-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            z-index: 2;
        }
        .instruction-overlay p {
            font-size: 1.2rem;
            max-width: 80%;
            margin: 10px 0;
        }
        .instruction-overlay.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="ar-container">
        <!-- Overlay de instrucciones para guiar al usuario -->
        <div id="instruction-overlay" class="instruction-overlay">
            <p>Mueve tu teléfono lentamente para detectar una superficie.</p>
        </div>

        <a-scene
            id="ar-scene"
            webxr="requiredFeatures: hit-test,local-floor; optionalFeatures: dom-overlay; overlayElement: .ar-container"
            vr-mode-ui="enabled: false"
            renderer="logarithmicDepthBuffer: true; antialias: true; colorManagement: true;"
        >
            <a-assets timeout="30000">
                <a-asset-item id="model-asset" src="" crossorigin="anonymous"></a-asset-item>
            </a-assets>

            <a-camera position="0 1.6 0"></a-camera>

            <!-- Cursor que se muestra sobre la superficie detectada -->
            <a-entity
                id="reticle"
                ar-hit-test="target: #model-container; type: ar"
                visible="false"
            >
                <a-ring
                    rotation="-90 0 0"
                    radius-inner="0.1"
                    radius-outer="0.15"
                    color="#007aff"
                ></a-ring>
            </a-entity>

            <!-- Contenedor para el modelo, inicialmente invisible y fuera de la vista -->
            <a-entity id="model-container" position="0 -100 0">
                 <a-entity
                    id="dynamic-model"
                    scale="0.1 0.1 0.1"
                    gltf-model=""
                    animation-mixer
                ></a-entity>
            </a-entity>
        </a-scene>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'https://apiwebra.scanmee.io';
            const scene = document.querySelector('a-scene');
            const reticle = document.getElementById('reticle');
            const modelContainer = document.getElementById('model-container');
            const instructionOverlay = document.getElementById('instruction-overlay');
            let modelPlaced = false;

            const initializeScene = async () => {
                try {
                    const pathParts = window.location.pathname.split('/');
                    const projectId = pathParts.pop() || pathParts.pop();
                    if (!projectId) throw new Error("ID de proyecto no encontrado.");

                    const response = await fetch(`${API_BASE_URL}/api/public/projects/${projectId}`);
                    if (!response.ok) throw new Error(`Proyecto no encontrado (Error: ${response.status})`);
                    
                    const projectData = await response.json();
                    if (!projectData.model_url) throw new Error("Datos del proyecto incompletos.");
                    
                    const modelAsset = document.getElementById('model-asset');
                    modelAsset.setAttribute('src', projectData.model_url);
                    
                    modelAsset.addEventListener('loaded', () => {
                        const model = document.getElementById('dynamic-model');
                        model.setAttribute('gltf-model', '#model-asset');
                    });

                } catch (error) {
                    instructionOverlay.innerHTML = `<p style="color: #ff4d4d;">Error: ${error.message}</p>`;
                }
            };
            
            // Cuando AR.js encuentra una superficie, muestra el cursor
            reticle.addEventListener('ar-hit-test-start', () => {
                 if (!modelPlaced) {
                    instructionOverlay.innerHTML = `<p>Toca la pantalla para colocar el objeto.</p>`;
                 }
            });

            // Cuando se detecta una superficie, muestra el cursor (retículo)
            reticle.addEventListener('ar-hit-test-found', () => {
                reticle.setAttribute('visible', true);
            });

            // Cuando se pierde la superficie, oculta el cursor
            reticle.addEventListener('ar-hit-test-lost', () => {
                reticle.setAttribute('visible', false);
            });

            // Al tocar la pantalla, coloca el modelo en la posición del cursor
            scene.addEventListener('click', (event) => {
                if (!modelPlaced && reticle.getAttribute('visible')) {
                    const position = reticle.getAttribute('position');
                    modelContainer.setAttribute('position', position);
                    modelContainer.setAttribute('visible', 'true');
                    modelPlaced = true;
                    // Oculta el cursor y las instrucciones una vez colocado
                    reticle.setAttribute('visible', false);
                    instructionOverlay.classList.add('hidden');
                }
            });

            // Inicializamos la carga de datos del proyecto
            initializeScene();
        });
    </script>
</body>
</html>
