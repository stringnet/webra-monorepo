<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Visualizador AR - WebRA Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Librerías -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-chromakey-material@^1.0.0/dist/aframe-chromakey-material.min.js"></script>
    <style>
        body {margin:0;overflow:hidden;}
        #playButton {
            position: absolute; z-index: 10; left: 50%; top: 60%; transform: translate(-50%, -50%);
            padding: 20px 35px; font-size: 1.5rem; border: none; border-radius: 12px; background: #2e88f8;
            color: #fff; cursor: pointer; box-shadow: 0 4px 30px rgba(0,0,0,0.1);
        }
        #debug {position:fixed;bottom:15px;left:15px;z-index:30;background:rgba(0,0,0,0.75);color:#fff;padding:10px 16px;border-radius:8px;font-size:1em;}
        .overlay { position: absolute; top:0; left:0; right:0; bottom:0; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index: 20; background:rgba(0,0,0,0.75); color:white; font-size:1.2rem;}
        .hidden {display:none;}
    </style>
</head>
<body>
    <div id="loader" class="overlay">
        <div style="margin-bottom:18px">Cargando proyecto...</div>
        <div class="spinner" style="border:5px solid #444;border-top:5px solid #fff;width:40px;height:40px;border-radius:50%;animation:spin 1s linear infinite"></div>
    </div>
    <button id="playButton" style="display:none;">▶ Play Video</button>
    <div id="ar-container"></div>
    <div id="debug" class="hidden"></div>
    <script>
        function hexToRGBString(hex) {
            hex = hex.replace(/^#/, '');
            if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
            const num = parseInt(hex, 16);
            return [
                ((num >> 16) & 255) / 255,
                ((num >> 8) & 255) / 255,
                (num & 255) / 255
            ].map(x => x.toFixed(2)).join(',');
        }
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'https://apiwebra.scanmee.io';
            const loader = document.getElementById('loader');
            const arContainer = document.getElementById('ar-container');
            const playButton = document.getElementById('playButton');
            const debug = document.getElementById('debug');

            const showError = msg => {
                loader.innerHTML = `<div style="color:red;">${msg}</div>`;
                loader.classList.remove('hidden');
            };

            function showDebug(info) {
                debug.innerHTML = info;
                debug.classList.remove('hidden');
                console.log('[DEBUG]', info.replace(/<br>/g, '\n'));
            }

            (async function(){
                try {
                    // Extraer el projectId dinámicamente de la URL
                    const pathParts = window.location.pathname.split('/');
                    const projectId = pathParts.pop() || pathParts.pop();
                    if (!projectId) throw new Error("ID de proyecto no encontrado.");

                    // Fetch de la API de tu backend
                    const response = await fetch(`${API_BASE_URL}/api/public/projects/${projectId}`);
                    if (!response.ok) throw new Error(`Proyecto no encontrado (Error ${response.status})`);
                    const projectData = await response.json();

                    if (projectData.asset_type === 'video') {
                        loader.classList.add('hidden');
                        playButton.style.display = "block";
                        const chromaColor = projectData.chroma_key_color || '#00FF00';
                        showDebug(
                            `<b>URL Video:</b> ${projectData.model_url}<br>` +
                            `<b>Chroma HEX:</b> ${chromaColor}<br>` +
                            `<b>Chroma RGB 0-1:</b> ${hexToRGBString(chromaColor)}`
                        );

                        playButton.onclick = function() {
                            playButton.style.display = "none";
                            loader.classList.remove('hidden');
                            arContainer.innerHTML = "";

                            // 1. Creamos video HTML (fuera de A-Frame) y esperamos readyState==4
                            const testVideo = document.createElement('video');
                            testVideo.src = projectData.model_url;
                            testVideo.crossOrigin = "anonymous";
                            testVideo.setAttribute('playsinline', '');
                            testVideo.setAttribute('webkit-playsinline', '');
                            testVideo.preload = 'auto';
                            testVideo.muted = true;
                            testVideo.loop = true;

                            testVideo.addEventListener('canplaythrough', function onCanPlay() {
                                showDebug(
                                    `<b>URL Video:</b> ${testVideo.src}<br>` +
                                    `<b>Chroma HEX:</b> ${chromaColor}<br>` +
                                    `<b>Chroma RGB 0-1:</b> ${hexToRGBString(chromaColor)}<br>` +
                                    `<b>Video readyState:</b> ${testVideo.readyState}`
                                );
                                testVideo.removeEventListener('canplaythrough', onCanPlay);

                                // 2. Ahora sí, insertamos la escena con el asset cargado
                                loader.classList.add('hidden');
                                const scene = document.createElement('a-scene');
                                scene.setAttribute('embedded', '');
                                scene.setAttribute('vr-mode-ui', 'enabled: false');
                                scene.setAttribute('arjs', 'sourceType: webcam; detectionMode: mono_and_matrix; debugUIEnabled: false;');
                                scene.setAttribute('renderer', 'logarithmicDepthBuffer: true;');

                                // Assets: el video
                                const assets = document.createElement('a-assets');
                                // Usar el mismo objeto video para asegurar buffer
                                testVideo.id = 'videoChroma';
                                assets.appendChild(testVideo);
                                scene.appendChild(assets);

                                const marker = document.createElement('a-marker');
                                if(projectData.marker_type === 'image' && projectData.marker_url) {
                                    marker.setAttribute('type', 'pattern');
                                    marker.setAttribute('url', projectData.marker_url);
                                } else {
                                    marker.setAttribute('preset', 'hiro'); 
                                }
                                marker.setAttribute('emitevents', 'true');
                                const chromaRGB = hexToRGBString(chromaColor);
                                const plane = document.createElement('a-plane');
                                plane.setAttribute('width', '1.6');
                                plane.setAttribute('height', '0.9');
                                plane.setAttribute('rotation', '-90 0 0');
                                plane.setAttribute('chromakey-material', `src: #videoChroma; color: ${chromaRGB};`);
                                marker.appendChild(plane);
                                scene.appendChild(marker);
                                scene.appendChild(document.createElement('a-camera'));
                                arContainer.appendChild(scene);

                                // Play seguro:
                                setTimeout(() => {
                                    testVideo.play().catch(() => {});
                                }, 250);
                            });
                            testVideo.load();
                        };
                    } else {
                        loader.classList.add('hidden');
                        arContainer.innerHTML = "";
                        const modelViewer = document.createElement('model-viewer');
                        modelViewer.setAttribute('src', projectData.model_url);
                        modelViewer.setAttribute('ar', '');
                        modelViewer.setAttribute('ar-modes', 'webxr scene-viewer quick-look');
                        modelViewer.setAttribute('camera-controls', '');
                        modelViewer.setAttribute('enable-pan', '');
                        modelViewer.setAttribute('autoplay', '');
                        modelViewer.setAttribute('crossorigin', 'anonymous');
                        modelViewer.style.width = "100vw";
                        modelViewer.style.height = "100vh";
                        arContainer.appendChild(modelViewer);
                        showDebug(`<b>Modo:</b> Modelo 3D<br><b>URL Modelo:</b> ${projectData.model_url}`);
                    }
                } catch(err) {
                    showError("ERROR: " + err.message);
                }
            })();
        });
    </script>
</body>
</html>
