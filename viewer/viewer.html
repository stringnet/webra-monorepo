<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visualizador de RA - WebRA</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
    .container { position: relative; width: 100vw; height: 100vh; }
    .overlay { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.8); color: #fff; z-index: 2; text-align: center; }
    .overlay.hidden { display: none; }
    .spinner { border: 5px solid #444; border-top: 5px solid #fff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #ar-container { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="loader" class="overlay">
    <div class="spinner"></div>
    <p id="loader-text">Cargando proyecto...</p>
  </div>

  <div id="ar-container" class="container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const API_BASE_URL = 'https://apiwebra.scanmee.io';
      const arContainer = document.getElementById('ar-container');
      const loader = document.getElementById('loader');
      const loaderText = document.getElementById('loader-text');

      const showError = msg => {
        loaderText.textContent = `Error: ${msg}`;
        const spinner = document.querySelector('.spinner');
        if (spinner) spinner.style.display = 'none';
      };

      const loadScript = (src, isModule = false) => new Promise((res, rej) => {
        if (document.querySelector(`script[src="${src}"]`)) return res();
        const s = document.createElement('script'); s.src = src;
        if (isModule) s.type = 'module';
        s.onload = res;
        s.onerror = () => rej(new Error(`No se pudo cargar el script: ${src}`));
        document.head.appendChild(s);
      });

      const initializeAframeVideo = projectData => {
        // Carga secuencial de librerÃ­as
        loadScript('https://aframe.io/releases/1.5.0/aframe.min.js')
        .then(() => loadScript('https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js'))
        .then(() => loadScript('https://unpkg.com/aframe-transparent-video-shader@1.0.6/dist/aframe-transparent-video-shader.umd.js'))
        .then(() => {
          const scene = document.createElement('a-scene');
          scene.setAttribute('embedded', '');
          scene.setAttribute('arjs', 'sourceType: webcam; debugUIEnabled: false');
          scene.setAttribute('renderer', 'alpha: true; antialias: true');

          // Assets
          const assets = document.createElement('a-assets');
          const videoEl = document.createElement('video');
          videoEl.id = 'video-asset';
          videoEl.setAttribute('src', projectData.model_url);
          videoEl.setAttribute('loop', '');
          videoEl.setAttribute('muted', '');
          videoEl.setAttribute('playsinline', '');
          videoEl.setAttribute('webkit-playsinline', '');
          videoEl.setAttribute('crossorigin', 'anonymous');
          assets.appendChild(videoEl);
          scene.appendChild(assets);

          // Marker
          const marker = document.createElement('a-marker');
          if (projectData.marker_type === 'image' && projectData.marker_url) {
            marker.setAttribute('type', 'pattern');
            marker.setAttribute('url', projectData.marker_url);
          } else marker.setAttribute('preset', 'hiro');
          marker.setAttribute('emitevents', 'true');

          // Plane for video
          const plane = document.createElement('a-plane');
          plane.setAttribute('geometry', 'width: 1.6; height: 0.9');
          plane.setAttribute('rotation', '-90 0 0');
          plane.setAttribute('material', 'shader: transparent-video; src: #video-asset; transparent: true; premultipliedAlpha: true');
          marker.appendChild(plane);

          scene.appendChild(marker);

          // Camera
          const cam = document.createElement('a-entity');
          cam.setAttribute('camera', '');
          scene.appendChild(cam);

          arContainer.appendChild(scene);

          scene.addEventListener('loaded', () => {
            loader.classList.add('hidden');
            videoEl.play().catch(() => {});
            marker.addEventListener('markerFound', () => videoEl.play());
            marker.addEventListener('markerLost', () => videoEl.pause());
          });
        })
        .catch(err => showError(err.message));
      };

      const initializeGltfModel = projectData => {
        loadScript('https://aframe.io/releases/1.5.0/aframe.min.js')
        .then(() => loadScript('https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js'))
        .then(() => {
          const scene = document.createElement('a-scene');
          scene.setAttribute('embedded', '');
          scene.setAttribute('arjs', 'sourceType: webcam; debugUIEnabled: false');
          scene.setAttribute('renderer', 'alpha: true; antialias: true');

          const assets = document.createElement('a-assets');
          const item = document.createElement('a-asset-item');
          item.id = 'model-asset';
          item.setAttribute('src', projectData.model_url);
          assets.appendChild(item);
          scene.appendChild(assets);

          const marker = document.createElement('a-marker');
          if (projectData.marker_type === 'image' && projectData.marker_url) {
            marker.setAttribute('type', 'pattern');
            marker.setAttribute('url', projectData.marker_url);
          } else marker.setAttribute('preset', 'hiro');
          marker.setAttribute('emitevents', 'true');

          const modelEnt = document.createElement('a-entity');
          modelEnt.setAttribute('gltf-model', '#model-asset');
          modelEnt.setAttribute('scale', '2 2 2');
          modelEnt.setAttribute('position', '0 0 0');
          marker.appendChild(modelEnt);

          scene.appendChild(marker);
          const cam = document.createElement('a-entity'); cam.setAttribute('camera', ''); scene.appendChild(cam);
          arContainer.appendChild(scene);

          scene.addEventListener('loaded', () => loader.classList.add('hidden'));
        })
        .catch(err => showError(err.message));
      };

      (async () => {
        try {
          const parts = window.location.pathname.split('/');
          const projectId = parts.pop() || parts.pop();
          if (!projectId) throw new Error('ID de proyecto no encontrado.');
          const resp = await fetch(`${API_BASE_URL}/api/public/projects/${projectId}`);
          if (!resp.ok) throw new Error(`Proyecto no encontrado (Error ${resp.status})`);
          const pd = await resp.json();

          if (pd.asset_type === 'video') initializeAframeVideo(pd);
          else initializeGltfModel(pd);
        } catch (e) {
          showError(e.message);
        }
      })();
    });
  </script>
</body>
</html>