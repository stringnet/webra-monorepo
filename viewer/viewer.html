<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualizador de RA - WebRA</title>
  <style>
    html, body { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; }
    .container { position: relative; width: 100%; height: 100%; }
    .overlay { position: absolute; inset: 0; display: flex;
      justify-content: center; align-items: center;
      background: rgba(0,0,0,0.8); color: #fff; z-index: 2; }
    .overlay.hidden { display: none; }
    .spinner {
      border: 5px solid #444;
      border-top: 5px solid #fff;
      border-radius: 50%;
      width: 50px; height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #ar-container { width: 100%; height: 100%; position: relative; }
    model-viewer { width: 100%; height: 100%; display: block; }
    video#vid { display: none; }
  </style>
</head>
<body>
  <div id="loader" class="overlay">
    <div class="spinner"></div>
    <p id="loader-text">Cargando proyecto...</p>
  </div>

  <div id="ar-container" class="container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const API_BASE_URL = 'https://apiwebra.scanmee.io';
      const arContainer = document.getElementById('ar-container');
      const loader = document.getElementById('loader');
      const loaderText = document.getElementById('loader-text');

      const showError = msg => {
        loaderText.textContent = `Error: ${msg}`;
        const spinner = document.querySelector('.spinner');
        if (spinner) spinner.style.display = 'none';
      };

      const loadScript = (src, module = false) => new Promise((res, rej) => {
        if (document.querySelector(`script[src="${src}"]`)) return res();
        const s = document.createElement('script');
        s.src = src;
        if (module) s.type = 'module';
        s.onload = res;
        s.onerror = () => rej(new Error(`No se pudo cargar script: ${src}`));
        document.head.appendChild(s);
      });

      const isIOS = () => {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      };

      const initializeAframeVideo = projectData => {
        loadScript('https://aframe.io/releases/1.5.0/aframe.min.js')
        .then(() => loadScript('https://unpkg.com/aframe-transparent-video-shader@1.0.6/dist/aframe-transparent-video-shader.umd.js'))
        .then(() => {
          const scene = document.createElement('a-scene');
          scene.setAttribute('embedded', '');
          scene.setAttribute('vr-mode-ui', 'enabled: false');
          scene.setAttribute('renderer', 'logarithmicDepthBuffer: true; alpha: true; antialias: true');

          const video = document.createElement('video');
          video.id = 'vid';
          video.setAttribute('loop', '');
          video.setAttribute('autoplay', '');
          video.setAttribute('muted', '');
          video.setAttribute('crossorigin', 'anonymous');
          video.setAttribute('playsinline', '');
          video.setAttribute('webkit-playsinline', '');
          video.setAttribute('preload', 'auto');

          const webmURL = projectData.model_url;
          const mp4URL = webmURL.replace(/\.webm$/i, '.mp4');
          video.src = isIOS() ? mp4URL : webmURL;

          document.body.appendChild(video);

          const marker = document.createElement('a-marker');
          if (projectData.marker_type === 'image' && projectData.marker_url) {
            marker.setAttribute('type', 'pattern');
            marker.setAttribute('url', projectData.marker_url);
          } else {
            marker.setAttribute('preset', 'hiro');
          }
          marker.setAttribute('emitevents', 'true');

          const plane = document.createElement('a-plane');
          plane.setAttribute('geometry', 'height: 1.5; width: 2.66');
          plane.setAttribute('rotation', '-90 0 0');
          plane.setAttribute('material', 'shader: transparent-video; src: #vid; transparent: true');
          marker.appendChild(plane);

          scene.appendChild(marker);
          scene.appendChild(document.createElement('a-camera'));
          arContainer.innerHTML = '';
          arContainer.appendChild(scene);

          scene.addEventListener('loaded', () => {
            loader.classList.add('hidden');
            const vid = document.getElementById('vid');
            const playOnInteraction = () => {
              vid.play().catch(() => {});
              document.body.removeEventListener('click', playOnInteraction);
            };
            document.body.addEventListener('click', playOnInteraction);
            marker.addEventListener('markerFound', () => vid.play());
            marker.addEventListener('markerLost', () => vid.pause());
          });
        })
        .catch(err => showError(err.message));
      };

      const initializeModelViewer = projectData => {
        loadScript('https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js', true)
        .then(() => {
          const mv = document.createElement('model-viewer');
          mv.setAttribute('src', projectData.model_url);
          mv.setAttribute('alt', `3D de ${projectData.name}`);
          mv.setAttribute('ar', '');
          mv.setAttribute('ar-modes', 'webxr scene-viewer quick-look');
          mv.setAttribute('camera-controls', '');
          mv.setAttribute('enable-pan', '');
          mv.setAttribute('autoplay', '');
          mv.setAttribute('crossorigin', 'anonymous');
          mv.style.width = '100%';
          mv.style.height = '100%';
          arContainer.innerHTML = '';
          arContainer.appendChild(mv);
          mv.addEventListener('load', () => loader.classList.add('hidden'));
          mv.addEventListener('error', () => showError('No se pudo cargar el modelo 3D.'));
        })
        .catch(err => showError(err.message));
      };

      (async () => {
        try {
          const parts = window.location.pathname.split('/');
          const projectId = parts.pop() || parts.pop();
          if (!projectId) throw new Error("ID de proyecto no encontrado.");

          const resp = await fetch(`${API_BASE_URL}/api/public/projects/${projectId}`);
          if (!resp.ok) throw new Error(`Proyecto no encontrado (Error ${resp.status})`);
          const pd = await resp.json();

          if (pd.asset_type === 'video') initializeAframeVideo(pd);
          else initializeModelViewer(pd);
        } catch (e) {
          showError(e.message);
        }
      })();
    });
  </script>
</body>
</html>
