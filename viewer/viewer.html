<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Visualizador AR PRO UX</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Librerías -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-chromakey-material@^1.0.0/dist/aframe-chromakey-material.min.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
    <style>
        body {margin:0;overflow:hidden;}
        #playButton {
            position: absolute; z-index: 10; left: 50%; top: 65%; transform: translate(-50%, -50%);
            padding: 20px 35px; font-size: 1.5rem; border: none; border-radius: 12px; background: #2e88f8;
            color: #fff; cursor: pointer; box-shadow: 0 4px 30px rgba(0,0,0,0.1); display: none;
        }
        #videoPreview {
            position: absolute; z-index: 9; left: 50%; top: 45%; transform: translate(-50%, -50%);
            max-width: 90vw; max-height: 45vh; border-radius: 14px; box-shadow: 0 4px 30px rgba(0,0,0,0.3); background: #000;
            display: none;
        }
        #debug {position:fixed;bottom:15px;left:15px;z-index:30;background:rgba(0,0,0,0.85);color:#fff;padding:14px 20px 8px 18px;border-radius:8px;font-size:1em;max-width:60vw;}
        .overlay { position: absolute; top:0; left:0; right:0; bottom:0; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index: 20; background:rgba(0,0,0,0.75); color:white; font-size:1.2rem;}
        .hidden {display:none;}
        model-viewer { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="loader" class="overlay">
        <div style="margin-bottom:18px">Cargando proyecto...</div>
        <div class="spinner" style="border:5px solid #444;border-top:5px solid #fff;width:40px;height:40px;border-radius:50%;animation:spin 1s linear infinite"></div>
    </div>
    <button id="playButton">▶ Iniciar Experiencia AR</button>
    <video id="videoPreview" muted loop playsinline webkit-playsinline></video>
    <div id="ar-container"></div>
    <div id="debug" class="hidden"></div>
    <script>
        function hexToRGBString(hex) {
            hex = hex.replace(/^#/, '');
            if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
            const num = parseInt(hex, 16);
            return [
                ((num >> 16) & 255) / 255,
                ((num >> 8) & 255) / 255,
                (num & 255) / 255
            ].map(x => x.toFixed(2)).join(',');
        }
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'https://apiwebra.scanmee.io';
            const loader = document.getElementById('loader');
            const arContainer = document.getElementById('ar-container');
            const playButton = document.getElementById('playButton');
            const debug = document.getElementById('debug');
            const videoPreview = document.getElementById('videoPreview');

            const showError = msg => {
                loader.innerHTML = `<div style="color:red;">${msg}</div>`;
                loader.classList.remove('hidden');
                debug.innerHTML += `<div style="color:red;"><b>ERROR:</b> ${msg}</div>`;
                debug.classList.remove('hidden');
                console.error(msg);
            };

            function showDebug(info, important) {
                debug.innerHTML += info + "<br>";
                debug.classList.remove('hidden');
                if (important) console.warn('[DEBUG]', info.replace(/<br>/g, '\n'));
                else console.log('[DEBUG]', info.replace(/<br>/g, '\n'));
            }

            (async function(){
                try {
                    // Extraer el projectId dinámicamente de la URL
                    const pathParts = window.location.pathname.split('/');
                    const projectId = pathParts.pop() || pathParts.pop();
                    if (!projectId) throw new Error("ID de proyecto no encontrado.");

                    // Fetch de la API de tu backend
                    const response = await fetch(`${API_BASE_URL}/api/public/projects/${projectId}`);
                    if (!response.ok) throw new Error(`Proyecto no encontrado (Error ${response.status})`);
                    const projectData = await response.json();

                    debug.innerHTML = ""; // Limpiar logs previos
                    showDebug(`<b>ProjectID:</b> ${projectId}`, true);

                    // --- CARGA DINÁMICA DE VIDEO ---
                    if (projectData.asset_type === 'video') {
                        // Comienza mostrando solo el loader
                        loader.classList.remove('hidden');
                        playButton.style.display = "none";
                        videoPreview.style.display = "none";

                        // Setear src, color y logs previos
                        const chromaColor = projectData.chroma_key_color || '#00FF00';
                        const chromaRGB = hexToRGBString(chromaColor);

                        videoPreview.src = projectData.model_url;
                        videoPreview.load();

                        showDebug(`<b>URL Video:</b> ${projectData.model_url}<br>` +
                            `<b>Chroma HEX:</b> ${chromaColor}<br>` +
                            `<b>Chroma RGB 0-1:</b> ${chromaRGB}`, true);

                        // LOGS de eventos del video
                        ["loadstart", "loadedmetadata", "canplay", "canplaythrough", "playing", "pause", "ended", "error"].forEach(evt => {
                            videoPreview.addEventListener(evt, () => {
                                showDebug(`<b>Video event:</b> ${evt}, readyState: ${videoPreview.readyState}, network: ${videoPreview.networkState}`);
                            });
                        });
                        videoPreview.onerror = (e) => showError("Error al cargar el video (revisa CORS o formato)");

                        // Cuando puede reproducirse, muestra preview y botón y oculta loader
                        videoPreview.oncanplaythrough = () => {
                            showDebug(`<span style="color:lime"><b>Video listo para reproducir</b></span>`, true);
                            loader.classList.add('hidden');
                            videoPreview.style.display = "block";
                            playButton.style.display = "block";
                            videoPreview.play().catch(()=>{});
                        };

                        // Si hay error, mostrarlo
                        videoPreview.onstalled = () => showError("Video stalled, revisa el servidor o el formato.");
                        videoPreview.onabort = () => showError("La carga de video fue abortada.");

                        // Cuando dan play, inicia la experiencia AR
                        playButton.onclick = function() {
                            playButton.style.display = "none";
                            videoPreview.style.display = "none";
                            loader.innerHTML = "<div>Iniciando AR y solicitando permisos de cámara...</div><div class='spinner' style='margin-top:20px;border:5px solid #444;border-top:5px solid #fff;width:40px;height:40px;border-radius:50%;animation:spin 1s linear infinite'></div>";
                            loader.classList.remove('hidden');
                            arContainer.innerHTML = "";
                            debug.innerHTML += `<hr><b>Iniciando escena AR...</b><br>`;

                            // Creamos la escena y solo cuando video ya estaba OK
                            const scene = document.createElement('a-scene');
                            scene.setAttribute('embedded', '');
                            scene.setAttribute('vr-mode-ui', 'enabled: false');
                            scene.setAttribute('arjs', 'sourceType: webcam; detectionMode: mono_and_matrix; debugUIEnabled: false;');
                            scene.setAttribute('renderer', 'logarithmicDepthBuffer: true;');

                            // Assets: el mismo objeto video
                            const assets = document.createElement('a-assets');
                            videoPreview.setAttribute('id', 'videoChroma');
                            videoPreview.muted = false; // Ahora sí habilita audio si corresponde
                            assets.appendChild(videoPreview);
                            scene.appendChild(assets);

                            // Marker AR
                            const marker = document.createElement('a-marker');
                            if(projectData.marker_type === 'image' && projectData.marker_url) {
                                marker.setAttribute('type', 'pattern');
                                marker.setAttribute('url', projectData.marker_url);
                            } else {
                                marker.setAttribute('preset', 'hiro'); 
                            }
                            marker.setAttribute('emitevents', 'true');
                            // Plano con shader chroma
                            const plane = document.createElement('a-plane');
                            plane.setAttribute('width', '1.6');
                            plane.setAttribute('height', '0.9');
                            plane.setAttribute('rotation', '-90 0 0');
                            plane.setAttribute('chromakey-material', `src: #videoChroma; color: ${chromaRGB};`);
                            marker.appendChild(plane);
                            scene.appendChild(marker);
                            scene.appendChild(document.createElement('a-camera'));
                            arContainer.appendChild(scene);

                            setTimeout(() => {
                                videoPreview.play().then(()=>{
                                    showDebug("<b>Video play() ejecutado en modo AR.</b>", true);
                                }).catch(e=>{
                                    showDebug("<b>ERROR play():</b> " + e, true);
                                });
                                loader.classList.add('hidden');
                            }, 250);
                        };

                    // --- CARGA DE MODELO 3D ---
                    } else {
                        loader.classList.add('hidden');
                        arContainer.innerHTML = "";
                        debug.innerHTML += "<b>Cargando modelo 3D...</b><br>";
                        const modelViewer = document.createElement('model-viewer');
                        modelViewer.setAttribute('src', projectData.model_url);
                        modelViewer.setAttribute('ar', '');
                        modelViewer.setAttribute('ar-modes', 'webxr scene-viewer quick-look');
                        modelViewer.setAttribute('camera-controls', '');
                        modelViewer.setAttribute('enable-pan', '');
                        modelViewer.setAttribute('autoplay', '');
                        modelViewer.setAttribute('crossorigin', 'anonymous');
                        modelViewer.style.width = "100vw";
                        modelViewer.style.height = "100vh";
                        arContainer.appendChild(modelViewer);
                        showDebug(`<b>Modo:</b> Modelo 3D<br><b>URL Modelo:</b> ${projectData.model_url}`, true);

                        // LOG: modelo 3d
                        modelViewer.addEventListener('load', ()=>showDebug("<b>Modelo 3D cargado OK.</b>", true));
                        modelViewer.addEventListener('error', ()=>showError("Error al cargar el modelo 3D"));
                    }
                } catch(err) {
                    showError("ERROR: " + err.message);
                }
            })();
        });
    </script>
</body>
</html>
