<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de RA - WebRA</title>
    <!-- Importamos A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .ar-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            z-index: 2;
        }
        .overlay p {
            font-size: 1.2rem;
            max-width: 80%;
            margin: 10px 0;
        }
        .overlay button {
            padding: 12px 24px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #007aff;
            background-color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 20px;
        }
        .overlay.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="ar-container">
        <!-- Overlay de instrucciones para guiar al usuario -->
        <div id="instruction-overlay" class="overlay">
            <p id="instruction-text">Cargando datos del proyecto...</p>
            <button id="enter-ar-btn" style="display: none;">Iniciar RA</button>
        </div>
        <!-- El contenedor de la escena se deja vacío y se llenará con JS -->
        <div id="scene-container"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'https://apiwebra.scanmee.io';
            const sceneContainer = document.getElementById('scene-container');
            const instructionOverlay = document.getElementById('instruction-overlay');
            const instructionText = document.getElementById('instruction-text');
            const enterArBtn = document.getElementById('enter-ar-btn');
            
            let projectData = null;
            let modelPlaced = false;

            const showError = (message) => {
                instructionText.innerHTML = `<p style="color: #ff4d4d;">Error: ${message}</p>`;
                enterArBtn.style.display = 'none';
            };
            
            const createScene = () => {
                // Crear la escena de A-Frame dinámicamente
                const sceneEl = document.createElement('a-scene');
                sceneEl.setAttribute('webxr', 'requiredFeatures: hit-test,local-floor; optionalFeatures: dom-overlay; overlayElement: .ar-container');
                sceneEl.setAttribute('vr-mode-ui', 'enabled: false');
                sceneEl.setAttribute('renderer', 'logarithmicDepthBuffer: true; antialias: true; colorManagement: true;');
                
                // Assets
                const assetsEl = document.createElement('a-assets');
                assetsEl.setAttribute('timeout', '30000');
                const modelAssetEl = document.createElement('a-asset-item');
                modelAssetEl.id = 'model-asset';
                modelAssetEl.setAttribute('src', projectData.model_url);
                modelAssetEl.setAttribute('crossorigin', 'anonymous');
                assetsEl.appendChild(modelAssetEl);
                sceneEl.appendChild(assetsEl);

                // Cámara
                const cameraEl = document.createElement('a-camera');
                cameraEl.setAttribute('position', '0 1.6 0');
                sceneEl.appendChild(cameraEl);

                // Contenedor del modelo
                const modelContainerEl = document.createElement('a-entity');
                modelContainerEl.id = 'model-container';
                modelContainerEl.setAttribute('position', '0 -100 0'); // Fuera de la vista
                
                const modelEl = document.createElement('a-entity');
                modelEl.id = 'dynamic-model';
                modelEl.setAttribute('scale', '0.1 0.1 0.1');
                modelEl.setAttribute('gltf-model', '#model-asset');
                modelEl.setAttribute('animation-mixer', '');
                modelContainerEl.appendChild(modelEl);
                sceneEl.appendChild(modelContainerEl);
                
                // Retículo
                const reticleEl = document.createElement('a-entity');
                reticleEl.id = 'reticle';
                reticleEl.setAttribute('ar-hit-test', 'target: #model-container; type: ar');
                reticleEl.setAttribute('visible', 'false');
                const ringEl = document.createElement('a-ring');
                ringEl.setAttribute('rotation', '-90 0 0');
                ringEl.setAttribute('radius-inner', '0.1');
                ringEl.setAttribute('radius-outer', '0.15');
                ringEl.setAttribute('color', '#007aff');
                reticleEl.appendChild(ringEl);
                sceneEl.appendChild(reticleEl);

                sceneContainer.appendChild(sceneEl);
                return sceneEl;
            };
            
            const initializeAr = async () => {
                const sceneEl = createScene();

                // Esperar a que la escena se cargue antes de añadir listeners
                sceneEl.addEventListener('loaded', () => {
                    const reticle = document.getElementById('reticle');
                    const modelContainer = document.getElementById('model-container');

                    // Lógica para entrar en modo RA
                    instructionText.textContent = '¡Listo para comenzar!';
                    enterArBtn.style.display = 'block';

                    enterArBtn.addEventListener('click', async () => {
                        try {
                            await sceneEl.enterVR();
                        } catch (e) {
                            showError('Este dispositivo no soporta WebXR o el navegador no tiene permisos.');
                        }
                    });

                    sceneEl.addEventListener('enter-vr', () => {
                        instructionText.textContent = 'Mueve tu teléfono lentamente para detectar una superficie.';
                        enterArBtn.style.display = 'none';
                    });

                    reticle.addEventListener('ar-hit-test-start', () => {
                        if (!modelPlaced) instructionText.textContent = 'Toca la pantalla para colocar el objeto.';
                    });
                    reticle.addEventListener('ar-hit-test-found', () => reticle.setAttribute('visible', true));
                    reticle.addEventListener('ar-hit-test-lost', () => reticle.setAttribute('visible', false));

                    sceneEl.addEventListener('click', () => {
                        if (!modelPlaced && reticle.getAttribute('visible')) {
                            const position = reticle.getAttribute('position');
                            modelContainer.setAttribute('position', position);
                            modelContainer.setAttribute('visible', 'true');
                            modelPlaced = true;
                            reticle.setAttribute('visible', false);
                            instructionOverlay.classList.add('hidden');
                        }
                    });
                });
            };

            const loadProjectData = async () => {
                try {
                    // Primero, verificar compatibilidad
                    if (!navigator.xr) {
                        throw new Error("Tu navegador no soporta Realidad Aumentada (WebXR).");
                    }
                    const isSupported = await navigator.xr.isSessionSupported('immersive-ar');
                    if (!isSupported) {
                        throw new Error("Tu dispositivo no soporta Realidad Aumentada (WebXR).");
                    }

                    // Si es compatible, cargar los datos
                    const pathParts = window.location.pathname.split('/');
                    const projectId = pathParts.pop() || pathParts.pop();
                    if (!projectId) throw new Error("ID de proyecto no encontrado.");

                    const response = await fetch(`${API_BASE_URL}/api/public/projects/${projectId}`);
                    if (!response.ok) throw new Error(`Proyecto no encontrado (Error: ${response.status})`);
                    
                    projectData = await response.json();
                    if (!projectData.model_url) throw new Error("Datos del proyecto incompletos.");
                    
                    // Si todo está bien, inicializar la escena
                    initializeAr();

                } catch (error) {
                    showError(error.message);
                }
            };
            
            loadProjectData();
        });
    </script>
</body>
</html>
